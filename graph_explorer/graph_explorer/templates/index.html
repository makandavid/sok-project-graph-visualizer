{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8"/>
    <script type="text/javascript" src="https://d3js.org/d3.v4.js"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'style.css' %}"/>
    <link rel="stylesheet" href="{% static 'treeview-style.css' %}"/>
    <title>Graph Explorer</title>
</head>

<body>
<div class="header" id="header">
    <h1>Graph<br/>Visualizer</h1>

    <div class="controls">
        <div class="source-controls">
            <label>Source:
                <select class="source-select" id="source-select">
                    {% for plugin in data_source_plugins %}
                        <option value="{{ plugin.id }}">{{ plugin.name }}</option>
                    {% endfor %}
                </select>
                <button id="new-source-button">New</button>
            </label>
        </div>

        <!-- File Upload Section -->
        <div class="upload-controls">
            <form id="upload-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <label for="data-file">Upload File:
                    <input type="file" id="file-upload" name="file"/>
                </label>
                <button type="submit" id="upload-button">Upload & Visualize</button>
            </form>
        </div>

        <div class="filter-controls">
            <form action="/search">
                <input type="text" name="search" placeholder="Search..." size="24"/>
                <button type="submit">Search</button>
            </form>
            <form action="/search">
                <input type="text" name="attr" placeholder="attr" size="5"/>
                <select name="op">
                    <option value="eq">==</option>
                    <option value="le">&le;</option>
                    <option value="ge">&ge;</option>
                    <option value="lt">&lt;</option>
                    <option value="gt">&gt;</option>
                    <option value="ne">!=</option>
                </select>
                <input type="text" name="val" placeholder="val" size="5"/>
                <button type="submit">Filter</button>
            </form>
        </div>
        <div class="applied-filters">
            <div>
                <select style="width: 200px;">
                    <option>Applied Filters</option>
                    {% if applied_filters %}
                        {% for f in applied_filters %}
                            <option disabled>{{ f }}</option>
                        {% endfor %}
                    {% else %}
                        <option disabled>No filters applied</option>
                    {% endif %}
                </select>
            </div>
            <form action="/reset">
                <button type="submit">Reset Filters</button>
            </form>
        </div>
        <div class="view-buttons">
            <button id="simple-view-button">Simple View</button>
            <button id="block-view-button">Block View</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="sidebar">
        <div class="treeview">
            <ul id="treeview"></ul>
        </div>

        <div class="birdview">
            <svg id="birdview" width="300" height="120">
                <rect width="100%" height="100%" fill="white" stroke="gray"></rect>
            </svg>
        </div>
    </div>

    <div class="mainview">
        <svg id="mainview"></svg>
    </div>
</div>

    <div id="tooltip" style="position: absolute; text-align: left; padding: 15px;
    font-size: 14px; background: rgb(245, 247, 246);
    border: 1px solid #ccc; border-radius: 8px; pointer-events: none; opacity: 0;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.1);"></div>

    <script type="text/javascript">
        // Make plugin extensions mapping available to client
        const pluginExtensions = {{ plugin_extensions_json|safe }};
        const selectedPluginId = "{{ selected_data_plugin|default:'' }}";
    </script>

    <!-- prettier-ignore -->
    <script type="text/javascript">
        {{ visualization_script | safe }}
    </script>
    <script type="text/javascript" src="{% static 'treeview.js' %}"></script>


<script type="text/javascript">
    // Wait for DOM and all scripts to be ready
    document.addEventListener('DOMContentLoaded', function () {
        // Add a small delay to ensure everything is loaded
        setTimeout(function () {
            console.log('Checking for initial treeview initialization...');
            console.log('initializeTreeview type:', typeof window.initializeTreeview);
            console.log('graph available:', typeof graph !== 'undefined');

            if (typeof window.initializeTreeview === "function" && typeof graph !== 'undefined') {
                console.log('Initializing treeview with graph:', graph);
                window.initializeTreeview(graph);
            } else {
                console.warn('Cannot initialize treeview - missing function or graph data');
            }
        }, 200);
    });
</script>

    <script type="text/javascript">
        // update file accept attribute based on the selected data source plugin
        const sourceSelect = document.getElementById('source-select');
        const fileInput = document.getElementById('file-upload');

        function updateFileAccept() {
            const sel = sourceSelect.value;
            const exts = pluginExtensions[sel] || [];
            fileInput.accept = exts.join(',');
        }

        updateFileAccept();
        sourceSelect.addEventListener('change', updateFileAccept);

        // Handle file upload form submission
        document.getElementById('upload-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file to upload.');
                return;
            }

            const allowed = pluginExtensions[sourceSelect.value] || [];
            const lowerName = file.name.toLowerCase();
            const ok = allowed.some(ext => lowerName.endsWith(ext.toLowerCase()));
            if (!ok) {
                alert('Selected file type is not supported by the chosen data source plugin.');
                return;
            }

            const uploadButton = document.getElementById('upload-button');
            const originalText = uploadButton.textContent;
            uploadButton.textContent = 'Processing...';
            uploadButton.disabled = true;

            // the browser will set the correct multipart Content-Type
            const form = new FormData();
            form.append('file', file);
            form.append('plugin_id', sourceSelect.value);

            fetch('/upload-graph/', {
                method: 'POST',
                body: form,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.visualization_script) {
                        document.getElementById('mainview').innerHTML = '';
                        document.getElementById('treeview').innerHTML = '';
                        document.getElementById('birdview').innerHTML = '';

                        eval(data.visualization_script);

                        setTimeout(() => {
                            if (typeof window.initializeTreeview === 'function' && typeof graph !== 'undefined') {
                                window.initializeTreeview(graph);
                            } else {
                                console.error('Graph or initializeTreeview not available');
                            }
                        }, 100);
                    }
                } else {
                    console.error('Upload failed:', data.error);
                    alert('Upload failed: ' + (data.error || 'unknown error'));
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                alert('Upload error: ' + error.message);
            })
            .finally(() => {
                uploadButton.textContent = originalText;
                uploadButton.disabled = false;
                fileInput.value = '';
            });
        });
    </script>

{% if error_message %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            alert("Filter error: {{ error_message|escapejs }}");
        });
    </script>
{% endif %}


<script>
    document.getElementById("block-view-button").addEventListener("click", function () {
        window.location.href = "/change_visualization_plugin?id=block_visualizer";
    });
    document.getElementById("simple-view-button").addEventListener("click", function () {
        window.location.href = "/change_visualization_plugin?id=simple_visualizer";
    });
</script>


</body>

</html>